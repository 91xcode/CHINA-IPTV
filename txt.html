<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U转TXT结果</title>
    <script>
        // 解析M3U文件为TXT格式
        function parseM3UToTXT(m3uContent) {
            const lines = m3uContent.split('\n');
            const channels = {};
            let currentGroup = '未分组';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('#EXTINF:-1')) {
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    const nameMatch = line.match(/tvg-name="([^"]*)"/);
                    const group = groupMatch ? groupMatch[1] : currentGroup;
                    const name = nameMatch ? nameMatch[1] : line.split(',').pop();
                    const url = lines[i + 1] ? lines[i + 1].trim() : '';

                    if (url && url.length > 0) {
                        if (!channels[group]) {
                            channels[group] = [];
                        }
                        channels[group].push(`${name},${url}`);
                        currentGroup = group;
                    }
                }
            }

            let txtContent = '';
            for (const [group, channelList] of Object.entries(channels)) {
                txtContent += `${group},#genre#\n`;
                txtContent += channelList.join('\n') + '\n\n';
            }

            return txtContent.trim();
        }

        // 获取URL参数
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 页面加载完成后执行
        window.addEventListener('DOMContentLoaded', async function() {
            const m3uUrl = getQueryParam('url');

            if (!m3uUrl) {
                document.body.textContent = '错误：URL参数中未提供M3U文件地址';
                return;
            }

            try {
                // 获取M3U文件内容
                const response = await fetch(m3uUrl);
                if (!response.ok) {
                    throw new Error(`无法获取文件: ${response.status} ${response.statusText}`);
                }

                const m3uContent = await response.text();

                // 解析为TXT格式
                const txtContent = parseM3UToTXT(m3uContent);

                // 显示结果
                document.body.textContent = txtContent;
            } catch (error) {
                document.body.textContent = `转换失败: ${error.message}`;
            }
        });
    </script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            background: #f8f9fa;
            color: #333;
        }

        /* 添加极简的加载提示 */
        body:empty::before {
            content: "正在加载并转换M3U文件，请稍候...";
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
</body>
</html>